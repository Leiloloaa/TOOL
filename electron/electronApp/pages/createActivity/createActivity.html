<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üõ†Ô∏èÂâçÁ´ØÂ∑•ÂÖ∑</title>
    <link
      href="https://cn.vitejs.dev/logo-with-shadow.png"
      rel="shortcut icon"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="../shared/sidebar-adapter.css" />
    <!-- ÂØºÂÖ•Â∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.45/dist/vue.global.js"></script>
    <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
      body {
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        min-height: 100vh;
        color: #333;
        overflow-x: hidden;
      }

      /* ÈöêËóèÊªöÂä®Êù°‰ΩÜ‰øùÊåÅÊªöÂä®ÂäüËÉΩ */
      body::-webkit-scrollbar {
        width: 0;
        background: transparent;
      }

      body::-webkit-scrollbar-track {
        background: transparent;
      }

      body::-webkit-scrollbar-thumb {
        background: transparent;
      }

      #app {
        max-width: 1000px;
        margin: 0 auto;
        min-height: 100vh;
      }

      .container {
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
      }

      .warp {
        margin: 0 auto;
        padding: 40px;
        background: white;
        border-radius: 25px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .content-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
      }

      .content-header h2 {
        font-size: 2rem;
        color: #333;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .content-header p {
        font-size: 1.1rem;
        color: #666;
        font-weight: 400;
      }

      #nav-container {
        min-height: 100px;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .form-label {
        min-width: 150px;
        font-weight: 500;
        color: #333;
        flex-shrink: 0;
      }

      .form-input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.2s;
        box-sizing: border-box;
      }

      .form-input:focus {
        outline: none;
        border-color: #409eff;
      }

      .radio-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        flex: 1;
      }

      .radio-button {
        padding: 8px 16px;
        border: 1px solid #dcdfe6;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        flex-shrink: 0;
      }

      .radio-button:hover {
        border-color: #409eff;
        color: #409eff;
      }

      .radio-button.active {
        background: #409eff;
        border-color: #409eff;
        color: white;
      }

      .button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      .button-primary {
        background: #409eff;
        color: white;
      }

      .button-primary:hover {
        background: #337ecc;
      }

      .button-success {
        background: #67c23a;
        color: white;
      }

      .button-success:hover {
        background: #529b2e;
      }

      .button-warning {
        background: #e6a23c;
        color: white;
      }

      .button-warning:hover {
        background: #cf9236;
      }

      .button:disabled {
        background: #c0c4cc;
        cursor: not-allowed;
      }

      .action-buttons {
        margin-top: 30px;
        display: flex;
        gap: 15px;
        justify-content: flex-start;
        flex-wrap: wrap;
        padding-left: 165px; /* ‰∏élabelÂÆΩÂ∫¶ÂØπÈΩê */
      }

      .message {
        padding: 10px 15px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 14px;
      }

      .message-success {
        background: #f0f9ff;
        border: 1px solid #b3d8ff;
        color: #409eff;
      }

      .message-error {
        background: #fef0f0;
        border: 1px solid #fbc4c4;
        color: #f56c6c;
      }

      .message-warning {
        background: #fdf6ec;
        border: 1px solid #f5dab1;
        color: #e6a23c;
      }

      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      /* Toast ÈÄöÁü•Ê†∑Âºè */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        pointer-events: none;
      }

      .toast {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 12px 16px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        pointer-events: auto;
        max-width: 300px;
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.success {
        border-left: 4px solid #52c41a;
      }

      .toast.error {
        border-left: 4px solid #ff4d4f;
      }

      .toast.info {
        border-left: 4px solid #1890ff;
      }

      .toast-icon {
        font-size: 16px;
      }

      .toast-message {
        font-size: 14px;
        color: #333;
      }

      .toast-content {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
      }

      /* ÂìçÂ∫îÂºèËÆæËÆ° */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .warp {
          padding: 30px;
        }

        .title {
          font-size: 24px;
          height: 60px;
          line-height: 60px;
        }

        .form-group {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .form-label {
          min-width: auto;
          margin-bottom: 4px;
        }

        .form-input {
          width: 100%;
        }

        .radio-group {
          width: 100%;
        }

        .action-buttons {
          flex-direction: column;
          align-items: center;
          padding-left: 0;
        }
      }

      /* Loading ÈÅÆÁΩ©Â±ÇÊ†∑Âºè */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .loading-content {
        background: white;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        min-width: 200px;
      }

      .loading-spinner {
        width: 24px;
        height: 24px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #1890ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 12px;
      }

      .loading-text {
        font-size: 14px;
        color: #333;
        font-weight: 500;
        margin-bottom: 4px;
      }

      .loading-time {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* ÁßªÈô§ÂÜ≤Á™ÅÁöÑÂØºËà™Ê†èÊ†∑ÂºèÔºåËÆ©Â∑¶‰æßËèúÂçïÈÄÇÈÖçCSSÂ§ÑÁêÜ */
      #nav-container {
        /* Á°Æ‰øùÂØºËà™ÂÆπÂô®Ê≠£Á°ÆÊòæÁ§∫ */
        display: block !important;
        min-height: auto !important;
        margin-bottom: 0 !important;
      }
    </style>
  </head>
  <body class="createActivity-page">
    <!-- Loading ÈÅÆÁΩ©Â±Ç -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-time" id="loadingTime">loading...</div>
      </div>
    </div>

    <div id="app">
      <div class="container">
        <!-- ÂØºËà™ËèúÂçï -->
        <div id="nav-container"></div>

        <div class="warp" :class="{ loading: form.fullscreenLoading }">
          <div class="content-header">
            <h2 style="margin-top: 0">Ê¥ªÂä®ÂàõÂª∫Â∑•ÂÖ∑</h2>
            <!-- <p>ÂàõÂª∫Ê¥ªÂä®„ÄÅ‰∏ä‰º†ÊñáÊ°à„ÄÅÁÆ°ÁêÜÈÖçÁΩÆ</p> -->
          </div>

          <!-- Ê∂àÊÅØÊèêÁ§∫ -->
          <div v-if="message" :class="['message', `message-${message.type}`]">
            {{ message.text }}
          </div>

          <!-- Toast ÈÄöÁü•ÂÆπÂô® -->
          <div id="toastContainer" class="toast-container"></div>

          <form @submit.prevent="onSubmit">
            <div class="form-group">
              <label class="form-label">Project Name</label>
              <div class="radio-group">
                <div
                  v-for="project in ['Yoho', 'Hiyoo', 'SoulStar']"
                  :key="project"
                  :class="['radio-button', { active: form.projectName === project }]"
                  @click="form.projectName = project"
                >
                  {{ project }}
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">General activity</label>
              <div class="radio-group">
                <div
                  v-for="option in ['true', 'false']"
                  :key="option"
                  :class="['radio-button', { active: form.isGeneral === option }]"
                  @click="form.isGeneral = option"
                >
                  {{ option }}
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Activity catalog</label>
              <input v-model="form.catalog" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Activity Name</label>
              <input v-model="form.name" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Activity id</label>
              <input v-model="form.id" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Document url</label>
              <input v-model="form.url" class="form-input" />
            </div>

            <div class="form-group" v-if="form.projectName != 'SoulStar'">
              <label class="form-label">Document text url</label>
              <input v-model="form.textUrl" class="form-input" />
            </div>

            <div class="form-group" v-if="form.projectName != 'SoulStar'">
              <label class="form-label">Upload python</label>
              <button
                type="button"
                class="button button-primary"
                @click="handleFileChange"
                :disabled="!form.id || !form.textUrl || uploadLoading"
              >
                {{ uploadLoading ? '‰∏ä‰º†‰∏≠...' : `${form.projectName} ===>
                upload` }}
              </button>
            </div>

            <div class="form-group" v-if="form.projectName != 'SoulStar'">
              <label class="form-label">Upload excel</label>
              <button
                type="button"
                class="button button-success"
                @click="handleFileChangeExcel"
              >
                upload excel
              </button>
            </div>

            <div class="form-group">
              <label class="form-label">Activity Figma</label>
              <input v-model="form.figma" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Background-color</label>
              <input v-model="form.bgc" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Swiper op</label>
              <div
                style="display: flex; gap: 10px; align-items: center; flex: 1"
              >
                <div class="radio-group" style="flex: none">
                  <div
                    v-for="option in ['true', 'false']"
                    :key="option"
                    :class="['radio-button', { active: form.op === option }]"
                    @click="form.op = option"
                  >
                    {{ option }}
                  </div>
                </div>
                <input
                  v-model="form.opNum"
                  class="form-input"
                  style="width: 200px; flex: none"
                  placeholder="swiper op num, default 1"
                />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Hot banner</label>
              <div class="radio-group">
                <div
                  v-for="option in ['true', 'false']"
                  :key="option"
                  :class="['radio-button', { active: form.hot === option }]"
                  @click="form.hot = option"
                >
                  {{ option }}
                </div>
              </div>
            </div>

            <div class="action-buttons">
              <button
                type="submit"
                class="button button-primary"
                :disabled="form.fullscreenLoading"
              >
                Create {{ form.projectName }} Activity
              </button>

              <button
                v-if="form.projectName != 'Yoho'"
                type="button"
                class="button button-warning"
                @click="updateBase"
              >
                Update Base
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- ÂêçÂçï‰∏ä‰º† -->
      <input
        style="display: none"
        type="file"
        ref="excelInput"
        accept=".xlsx,.xls"
        @change="excelInputChange($event)"
      />
    </div>

    <script>
      const { createApp, ref, reactive, watch } = Vue;

      const App = {
        setup() {
          const form = reactive({
            projectName: "Yoho",
            isGeneral: "false",
            catalog: dayjs().format("YYYYMM"),
            branch: "",
            bgc: "",
            name: "",
            id: "",
            url: "",
            textUrl: "",
            figma: "",
            op: "true",
            hot: "true",
            info: "", // ÊèêÊµã‰ø°ÊÅØ
            activityUrl: "", // Ê¥ªÂä®ÈìæÊé•
            opNum: "",
            fullscreenLoading: false,
          });

          // Ê∂àÊÅØÊèêÁ§∫
          const message = ref(null);

          // Ê∑ªÂä†‰∏ä‰º†Âä†ËΩΩÁä∂ÊÄÅ
          const uploadLoading = ref(false);

          // ÊòæÁ§∫Ê∂àÊÅØ
          const showMessage = (text, type = "success") => {
            message.value = { text, type };
            setTimeout(() => {
              message.value = null;
            }, 5000);
          };

          // ÊòæÁ§∫ Toast ÈÄöÁü•
          const showToast = (message, type = "info") => {
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;

            const icons = {
              success: "‚úÖ",
              error: "‚ùå",
              info: "‚ÑπÔ∏è",
            };

            toast.innerHTML = `
               <div class="toast-content">
                 <span class="toast-icon">${icons[type] || icons.info}</span>
                 <span class="toast-message">${message}</span>
               </div>
             `;

            const toastContainer = document.getElementById("toastContainer");
            toastContainer.appendChild(toast);

            // Ëß¶ÂèëÂä®Áîª
            setTimeout(() => {
              toast.classList.add("show");
            }, 10);

            // Ëá™Âä®ÁßªÈô§
            setTimeout(() => {
              toast.classList.remove("show");
              setTimeout(() => {
                if (toast.parentNode) {
                  toast.parentNode.removeChild(toast);
                }
              }, 300);
            }, 3000);
          };

          watch(
            () => form.isGeneral,
            () => {
              if (form.isGeneral == "true") {
                form.catalog = "general";
              } else {
                form.catalog = dayjs().format("YYYYMM");
              }
            }
          );

          const setItemWithExpiry = (key, value, expiryInHours) => {
            const now = new Date();
            const expiryTime = now.getTime() + expiryInHours * 60 * 60 * 1000;
            const item = {
              value: value,
              expiry: expiryTime,
            };
            localStorage.setItem(key, JSON.stringify(item));
          };

          const getItemWithExpiry = (key) => {
            console.log("Ëé∑ÂèñÊï∞ÊçÆ:", key);
            const itemStr = localStorage.getItem(key);
            if (!itemStr) {
              return null;
            }
            const item = JSON.parse(itemStr);
            const now = new Date();
            if (now.getTime() > item.expiry) {
              localStorage.removeItem(key);
              return null;
            }
            console.log("Êï∞ÊçÆÊúâÊïà:", item.value);
            return item.value;
          };

          const getInfo = async () => {
            try {
              const response = await window.electronAPI.getActivityInfo();
              const { data } = response;
              Object.assign(form, data);
              form.name = data.branch;

              const oldForm = getItemWithExpiry("create_activity");
              if (oldForm) {
                console.log("Êï∞ÊçÆÊúâÊïà:", oldForm);
                oldForm &&
                  (form.projectName = oldForm.projectName) &&
                  (form.name = oldForm.name) &&
                  (form.id = oldForm.id) &&
                  (form.url = oldForm.url) &&
                  (form.textUrl = oldForm.textUrl) &&
                  (form.figma = oldForm.figma) &&
                  (form.bgc = oldForm.bgc) &&
                  (form.op = oldForm.op) &&
                  (form.hot = oldForm.hot) &&
                  (form.info = oldForm.info) &&
                  (form.activityUrl = oldForm.activityUrl) &&
                  (form.opNum = oldForm.opNum);
              } else {
                console.log("Êï∞ÊçÆÂ∑≤ËøáÊúüÊàñ‰∏çÂ≠òÂú®");
              }
            } catch (error) {
              console.error("Ëé∑Âèñ‰ø°ÊÅØÂ§±Ë¥•:", error);
              showToast("Ëé∑Âèñ‰ø°ÊÅØÂ§±Ë¥•: " + error.message, "error");
            }
          };

          const handleFileChange = async () => {
            if (!form.id || !form.textUrl || !form.projectName) {
              showToast("ËØ∑Â°´ÂÜôÈ°πÁõÆÂêçÁß∞„ÄÅIDÂíåÊñáÊú¨URL", "error");
              return;
            }

            uploadLoading.value = true;
            // ÊòæÁ§∫loadingÈÅÆÁΩ©Â±Ç
            showLoading("Ê≠£Âú®‰∏ä‰º†ÊñáÊú¨...");

            try {
              showToast(`ÂºÄÂßã‰∏ä‰º† ${form.projectName} ÊñáÊú¨...`, "success");

              const res = await window.electronAPI.uploadActivityText(form);

              if (res.data.code === 1) {
                console.log(
                  `Congrats, ${form.projectName} text have uploaded.`
                );
                showMessage(
                  `ÊàêÂäü‰∏ä‰º† ${form.projectName} ÊñáÊú¨ (${form.id})`,
                  "success"
                );
              } else {
                showToast(`‰∏ä‰º†Â§±Ë¥•: ${res.data.message}`, "error");
              }
            } catch (error) {
              console.error("‰∏ä‰º†ÊñáÊú¨Â§±Ë¥•:", error);
              showToast(
                `‰∏ä‰º†ÊñáÊú¨Â§±Ë¥•: ${error.message || "ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•"}`,
                "error"
              );
            } finally {
              uploadLoading.value = false;
              // ÈöêËóèloadingÈÅÆÁΩ©Â±Ç
              hideLoading();
            }
          };

          const handleInfo = () => {
            const map = {
              Yoho: {
                test: "https://activity-h5-test.yoho.media",
                master: "https://activity-h5.yoho.media",
              },
              Hiyoo: {
                test: "https://activity-h5-test.chatchill.media/activity-vite",
                master: "https://activity-h5.chatchill.media/activity-vite",
              },
              SoulStar: {
                test: "https://activity-h5-test.dopalive.com",
                master: "https://activity-h5.dopalive.com",
              },
            };

            const test = `${map[form.projectName].test}/act_v_${form.catalog}_${form.name}`;
            const master = `${map[form.projectName].master}/act_v_${form.catalog}_${form.name}`;

            const opTextLinks = [];
            const opMasterLinks = [];
            for (let i = 1; i <= form.opNum; i++) {
              opTextLinks.push(
                `${test}_op${form.opNum == 1 ? "" : i}/index.html?lang=&key=`
              );
              opMasterLinks.push(
                `${master}_op${form.opNum == 1 ? "" : i}/index.html?lang=&key=`
              );
            }

            const text = `üå∞Ê¥ªÂä®ÊèêÊµã: ${form.url}
      Figma: ${form.figma}
      Ê¥ªÂä®üÜî: ${form.id}
      Ê¥ªÂä®ÈìæÊé•(ÊµãËØï):
      ${test}/index.html?lang=&key=
      ${opTextLinks.join("\n")}
      ${form.hot == "true" ? `${test}_op_hot/index.html?lang=&key=` : "--"}
      Ê¥ªÂä®ÈìæÊé•(Ê≠£Âºè):
      ${master}/index.html?lang=EG&key=
      ${opMasterLinks.join("\n")}
      ${form.hot == "true" ? `${master}_op_hot/index.html?lang=&key=` : "--"}
      ÂâçÁ´Ø: ${shuffleArray(["@Stone", "@ÈòøÁî∞", "@ÁéÑÁ≠ñ"])}
      ÂêéÁ´Ø: ${shuffleArray(["@Â≠§Áãº", "@ÂæÖÁª≠", "@ÂêØ‰ªã", "@Á¥´Á∫¢"])}
      ÊµãËØï: ${shuffleArray(["@ÈöÜÂ§ö", "@‰øùÁΩó"])}`;

            form.info = text.replace(/--\n/g, "");
            form.activityUrl = `${master}/index.html?lang=&key=`;
            console.log(form.info);
          };

          const updateBase = async () => {
            const data = form;

            // ÊòæÁ§∫loadingÈÅÆÁΩ©Â±Ç
            showLoading("Ê≠£Âú®Êõ¥Êñ∞Âü∫Á°ÄÈÖçÁΩÆ...");

            try {
              const res = await window.electronAPI.updateActivityBase(data);
              showToast(
                res.data.message || "Êõ¥Êñ∞ÊàêÂäü",
                res.data.code === 1 ? "success" : "error"
              );
            } catch (error) {
              showToast(`Êõ¥Êñ∞Â§±Ë¥•: ${error.message}`, "error");
            } finally {
              // ÈöêËóèloadingÈÅÆÁΩ©Â±Ç
              hideLoading();
            }
          };

          // ÊòæÁ§∫loadingÈÅÆÁΩ©Â±Ç
          const showLoading = (text = "Ê≠£Âú®Â§ÑÁêÜ...") => {
            const loadingOverlay = document.getElementById("loadingOverlay");
            const loadingTime = document.getElementById("loadingTime");
            const loadingText = document.querySelector(".loading-text");

            if (loadingOverlay) {
              loadingOverlay.style.display = "flex";

              // Êõ¥Êñ∞loadingÊñáÊú¨
              if (loadingText) {
                loadingText.textContent = text;
              }

              // ÂºÄÂßãËÆ°Êó∂
              let seconds = 0;
              const timer = setInterval(() => {
                seconds++;
                if (loadingTime) {
                  loadingTime.textContent = `Á≠âÂæÖ: ${seconds}Áßí`;
                }
              }, 1000);

              // ‰øùÂ≠òtimerÂºïÁî®ÔºåÁî®‰∫éÊ∏ÖÈô§
              loadingOverlay.dataset.timer = timer;
            }
          };

          // ÈöêËóèloadingÈÅÆÁΩ©Â±Ç
          const hideLoading = () => {
            const loadingOverlay = document.getElementById("loadingOverlay");
            if (loadingOverlay) {
              loadingOverlay.style.display = "none";

              // Ê∏ÖÈô§ËÆ°Êó∂Âô®
              if (loadingOverlay.dataset.timer) {
                clearInterval(parseInt(loadingOverlay.dataset.timer));
                delete loadingOverlay.dataset.timer;
              }
            }
          };

          const onSubmit = async () => {
            if (!form.url) {
              showToast(`ËØ∑ËæìÂÖ•Ê¥ªÂä®ÊñáÊ°£URL`, "warning");
              return;
            }
            if (!form.opNum) {
              form.opNum = 1;
            }

            // ÊòæÁ§∫loadingÈÅÆÁΩ©Â±Ç
            showLoading("Ê≠£Âú®ÂàõÂª∫Ê¥ªÂä®Êñá‰ª∂...");
            form.fullscreenLoading = true;

            handleInfo();
            const data = { ...form };
            data.op = data.op == "true" ? "1" : "0";
            data.hot = data.hot == "true" ? "1" : "0";

            console.log("data", data);

            try {
              const res = await window.electronAPI.submitActivity(data);
              if (res.data.code === 1) {
                showToast(`ÊÅ≠ÂñúÔºåÊñá‰ª∂ÂàõÂª∫ÊàêÂäüÔºÅ`, "success");
              } else {
                showToast(`ÂàõÂª∫Â§±Ë¥•: ${res.data.message}`, "error");
              }
            } catch (error) {
              showToast(`ÂàõÂª∫Â§±Ë¥•: ${error.message}`, "error");
            } finally {
              // ÈöêËóèloadingÈÅÆÁΩ©Â±Ç
              hideLoading();
              form.fullscreenLoading = false;
            }

            console.log("JSON.stringify(form)", JSON.stringify(form));
            setItemWithExpiry(`create_activity`, form, 1);
          };

          function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
          }

          getInfo();

          const handleFileChangeExcel = async () => {
            console.log("handleFileChangeExcel called");
            if (!form.id) {
              showToast("ËØ∑ËæìÂÖ•Ê¥ªÂä®ID", "error");
              return;
            }

            try {
              // ‰ΩøÁî®Electron APIÈÄâÊã©Êñá‰ª∂
              const result = await window.electronAPI.selectFile({
                title: "ÈÄâÊã©ExcelÊñá‰ª∂",
                filters: [{ name: "Excel Files", extensions: ["xlsx", "xls"] }],
              });

              if (result.canceled) {
                console.log("Êñá‰ª∂ÈÄâÊã©Ë¢´ÂèñÊ∂à");
                return;
              }

              console.log("ÈÄâÊã©ÁöÑÊñá‰ª∂:", result.filePath);

              // ÊòæÁ§∫loadingÈÅÆÁΩ©Â±Ç
              showLoading("Ê≠£Âú®Â§ÑÁêÜExcelÊñá‰ª∂...");

              // Ê®°ÊãüÊñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
              const mockEvent = {
                target: {
                  value: result.filePath,
                  files: [
                    {
                      path: result.filePath,
                      name: result.filePath.split("/").pop(),
                    },
                  ],
                },
              };

              excelInputChange(mockEvent);
            } catch (error) {
              console.error("ÈÄâÊã©Êñá‰ª∂Â§±Ë¥•:", error);
              showToast("ÈÄâÊã©Êñá‰ª∂Â§±Ë¥•: " + error.message, "error");
              // ÈöêËóèloadingÈÅÆÁΩ©Â±Ç
              hideLoading();
            }
          };

          const excelInput = ref(null);

          async function excelInputChange(event) {
            console.log("excelInputChange triggered", event);
            console.log("File value:", event.target.value);

            const filePath = event.target.value;
            if (
              filePath.toUpperCase().endsWith("XLSX") ||
              filePath.toUpperCase().endsWith("XLS")
            ) {
              try {
                // ‰ΩøÁî®Electron APIËØªÂèñÊñá‰ª∂
                const fileData = await window.electronAPI.readFile(filePath);
                const data = new Uint8Array(fileData);
                const workbook = XLSX.read(data, { type: "array" });

                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];

                const columnData = {};
                for (const cellAddress in sheet) {
                  if (
                    cellAddress[0] === "!" ||
                    !sheet.hasOwnProperty(cellAddress)
                  )
                    continue;

                  const cell = sheet[cellAddress];
                  const columnName = cellAddress.match(/[A-Z]+/)[0];
                  const cellValue = cell.v;

                  if (!columnData[columnName]) {
                    columnData[columnName] = [];
                  }

                  columnData[columnName].push({
                    content: cellValue,
                    index: cellAddress.slice(1),
                  });
                }

                for (const columnName in columnData) {
                  const columnValues = columnData[columnName];
                  const _area = columnValues[0].content.replace(
                    /[\u4e00-\u9fa5\s]/g,
                    ""
                  );
                  console.log(_area, "_area");
                  const data = {
                    activityId: form.id,
                    area: ["Arabic", "XM", "EG"].includes(_area)
                      ? "ME"
                      : ["Chinese", "CN"].includes(_area)
                        ? "TW"
                        : _area,
                    content: `{"list":${JSON.stringify(columnValues)}}`,
                    count: columnValues.length,
                    operator: "stone@micous.com",
                    projectName: form.projectName, // Ê∑ªÂä†È°πÁõÆÂêçÁß∞
                  };

                  await upload(data);
                }

                event.target.value = "";
                // ÈöêËóèloadingÈÅÆÁΩ©Â±Ç
                hideLoading();
              } catch (error) {
                console.error("ËØªÂèñÊñá‰ª∂Â§±Ë¥•:", error);
                showToast("ËØªÂèñÊñá‰ª∂Â§±Ë¥•: " + error.message, "error");
                // ÈöêËóèloadingÈÅÆÁΩ©Â±Ç
                hideLoading();
              }
            }
          }

          const upload = async (data) => {
            if (
              ["ENGLISH", "NOTE", "EN", "EVENTTITLE"].includes(
                data.area.toUpperCase()
              )
            )
              return;

            // Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
            console.log("‰∏ä‰º†Êï∞ÊçÆ:", data);

            try {
              const res = await window.electronAPI.sendActivityText(data);
              if (res.data.code == 1) {
                console.log(`Congrats, ${data.area} text have uploaded.`);
                showToast(`ÊàêÂäü‰∏ä‰º† ${data.area} ÊñáÊú¨`, "success");
              } else {
                console.log(`Error, ${data.area} text hava error.`);
                console.log("APIÂìçÂ∫î:", res);
                showToast(
                  `${data.area} ÊñáÊú¨‰∏ä‰º†Âá∫Èîô: ${res.data.message || "Êú™Áü•ÈîôËØØ"}`,
                  "error"
                );
              }
            } catch (error) {
              console.error(`Error uploading ${data.area} text:`, error);
              showToast(
                `‰∏ä‰º† ${data.area} ÊñáÊú¨Â§±Ë¥•: ${error.message}`,
                "error"
              );
            }
          };

          return {
            form,
            message,
            onSubmit,
            handleInfo,
            handleFileChange,
            handleFileChangeExcel,
            updateBase,
            uploadLoading,
            upload,
            excelInputChange,
            excelInput,
            showToast,
          };
        },
      };

      const app = createApp(App);
      app.mount("#app");

      // Âä†ËΩΩÂØºËà™ËèúÂçï
      async function loadNavigation() {
        try {
          const result =
            await window.electronAPI.loadNavigation("createActivity");
          if (result.success) {
            // Ê≥®ÂÖ•CSSÊ†∑Âºè
            const style = document.createElement("style");
            style.textContent = result.css;
            document.head.appendChild(style);

            // Ê≥®ÂÖ•HTMLÂÜÖÂÆπ
            document.getElementById("nav-container").innerHTML = result.html;
          }
        } catch (error) {
          console.error("Failed to load navigation:", error);
        }
      }

      // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂä†ËΩΩÂØºËà™ËèúÂçï
      loadNavigation();

      // ÁßªÈô§Âº∫Âà∂‰øÆÂ§çÂØºËà™Ê†èÊ†∑ÂºèÁöÑ‰ª£Á†ÅÔºåËÆ©Â∑¶‰æßËèúÂçïÈÄÇÈÖçCSSÂ§ÑÁêÜ

      // Â§áÁî®Êñá‰ª∂ËæìÂÖ•‰∫ã‰ª∂ÁõëÂê¨Âô®
      setTimeout(() => {
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput) {
          console.log("Adding backup event listener to file input");
          fileInput.addEventListener("change", (event) => {
            console.log("Backup event listener triggered", event);
            // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî®Áõ∏ÂêåÁöÑÂ§ÑÁêÜÂáΩÊï∞
          });
        }
      }, 1000);
    </script>
  </body>
</html>
